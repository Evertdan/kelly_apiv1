Metadata-Version: 2.4
Name: kelly_api
Version: 0.1.0
Summary: Backend API para KellyBot usando FastAPI, RAG con Qdrant y LLMs.
Author-email: Tu Nombre / Equipo <tu.correo@example.com>
License: MIT
Keywords: fastapi,api,chatbot,rag,qdrant,vector database,embeddings,sentence-transformers,llm,deepseek,openai,mongodb,langchain
Classifier: Development Status :: 3 - Alpha
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Natural Language :: Spanish
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Topic :: Internet :: WWW/HTTP
Classifier: Topic :: Scientific/Engineering :: Artificial Intelligence
Requires-Python: >=3.10
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: fastapi<0.112.0,>=0.109.0
Requires-Dist: uvicorn[standard]<0.30.0,>=0.25.0
Requires-Dist: pydantic-settings<3.0.0,>=2.0.0
Requires-Dist: qdrant-client<2.0.0,>=1.9.0
Requires-Dist: sentence-transformers<3.0.0,>=2.2.0
Requires-Dist: numpy<2.0.0,>=1.21.0
Requires-Dist: torch
Requires-Dist: openai<2.0.0,>=1.10.0
Requires-Dist: langchain-core<0.3.0,>=0.1.0
Requires-Dist: langchain-mongodb<0.2.0,>=0.1.0
Requires-Dist: langchain-text-splitters<0.3.0,>=0.2.0
Requires-Dist: pymongo<5.0.0,>=4.0.0
Requires-Dist: markdown<4.0,>=3.5
Provides-Extra: dev
Requires-Dist: pytest<9.0.0,>=7.0.0; extra == "dev"
Requires-Dist: pytest-cov<6.0.0,>=4.0.0; extra == "dev"
Requires-Dist: pytest-mock<4.0.0,>=3.0.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.21.0; extra == "dev"
Requires-Dist: httpx<0.29.0,>=0.25.0; extra == "dev"
Requires-Dist: ruff<1.0.0,>=0.4.0; extra == "dev"
Requires-Dist: black<25.0.0,>=23.0.0; extra == "dev"
Requires-Dist: mypy<2.0.0,>=1.0.0; extra == "dev"
Requires-Dist: pre-commit<4.0.0,>=3.0.0; extra == "dev"
Provides-Extra: test
Requires-Dist: pytest<9.0.0,>=7.0.0; extra == "test"
Requires-Dist: pytest-cov<6.0.0,>=4.0.0; extra == "test"
Requires-Dist: pytest-mock<4.0.0,>=3.0.0; extra == "test"
Requires-Dist: pytest-asyncio>=0.21.0; extra == "test"
Requires-Dist: httpx<0.29.0,>=0.25.0; extra == "test"
Dynamic: license-file

# ğŸ¤– **Kelly API**  
**Backend para Chatbot con RAG (Retrieval-Augmented Generation)**  


## ğŸ“˜ 1. IntroducciÃ³n

### ğŸ¯ **1.1. PropÃ³sito de la API (Backend para KellyBot)**

Kelly API es un **backend robusto y centralizado** diseÃ±ado para potenciar al asistente conversacional **KellyBot**.  
Construido sobre el moderno framework **FastAPI (Python)**, actÃºa como el **"cerebro" del chatbot**, recibiendo preguntas desde mÃºltiples interfaces (como Telegram, apps web, etc.) y generando respuestas **inteligentes, coherentes y contextualizadas**.

ğŸ’¡ **Â¿QuÃ© hace?**
- Procesa lenguaje natural.
- Recupera informaciÃ³n relevante.
- Genera respuestas precisas y personalizadas.

### ğŸ§  **1.2. Funcionalidad Principal (Procesamiento RAG)**

El nÃºcleo del sistema utiliza el enfoque **RAG (Retrieval-Augmented Generation)**, mejorando la precisiÃ³n y actualizaciÃ³n de las respuestas mediante una combinaciÃ³n de bÃºsqueda + generaciÃ³n.

#### âš™ï¸ **Pasos del Pipeline RAG:**

1. ğŸ” **(Opcional) Contexto Prioritario:**  
   Consulta rÃ¡pida a un archivo local (`priority_context.json`) para preguntas frecuentes.
2. ğŸ•“ **(Opcional) Historial de ConversaciÃ³n:**  
   RecuperaciÃ³n del historial del usuario desde **MongoDB**.
3. ğŸ“š **RecuperaciÃ³n (Retrieval):**  
   - Se genera un embedding vectorial con `sentence-transformers`.
   - Se consulta la base de conocimiento en **Qdrant**.
4. â• **AumentaciÃ³n (Augmented):**  
   Se combinan:  
   - La pregunta original  
   - El historial  
   - El contexto recuperado  
5. âœ¨ **GeneraciÃ³n (Generation):**  
   Se envÃ­a todo esto a un **LLM** (como DeepSeek), con instrucciones personalizadas (estilo y tono de â€œKelyâ€) para crear una **respuesta empÃ¡tica, clara y Ãºtil**.

> âœ… Este proceso asegura que las respuestas sean **contextuales, basadas en datos reales y adaptadas al usuario final.**

### ğŸ”— **1.3. RelaciÃ³n con `kelly_soap` y `kelly_indexer`**

Kelly API **no trabaja sola**, forma parte de un ecosistema de tres componentes:

#### ğŸ§¾ `kelly_soap` â€“ ExtracciÃ³n de conocimiento
Convierte documentos semiestructurados (`.txt`, tipo SOAP) en archivos JSON estructurados de formato Pregunta/Respuesta.

- Campos clave: `faq_id`, `categoria`, `texto_para_vectorizar`, etc.

#### ğŸ“¦ `kelly_indexer` â€“ VectorizaciÃ³n e indexado
- Toma los JSON de `kelly_soap`
- Genera embeddings con `sentence-transformers`
- Los guarda en la base **Qdrant** junto con metadatos.

â¡ï¸ **Kelly API luego consulta esta base Qdrant**, preparada y actualizada por `kelly_indexer`.

### ğŸ‘¥ **1.4. PÃºblico Objetivo**

#### ğŸ‘¨â€ğŸ’» **Desarrolladores**
- Implementan y mantienen la API.
- Desarrollan clientes (Telegram bot, web apps, etc.) que la consumen.

#### ğŸ‘©â€ğŸ’¼ **Usuarios Finales**
- Contadores y personal administrativo de **Computo Contable Soft**.
- Con conocimientos tecnolÃ³gicos variables.

ğŸ§‘â€ğŸ« Por eso, **"Kely"** debe:
- Ser clara y empÃ¡tica.  
- Evitar jerga tÃ©cnica innecesaria.  
- Guiar paso a paso.  

## ğŸ—ï¸ 2. Arquitectura General

Esta secciÃ³n describe la estructura principal de **Kelly API** y cÃ³mo sus componentes colaboran para procesar las consultas del usuario y generar respuestas inteligentes.

### ğŸ§© **2.1. Componentes Principales e Interacciones**

KellyBot tiene una arquitectura **modular y escalable**, diseÃ±ada para que cada parte tenga una responsabilidad clara.

#### ğŸ”„ **Flujo de InteracciÃ³n General:**

1. ğŸ§‘â€ğŸ’» **Cliente:**  
   - Bot de Telegram, interfaz web o mÃ³vil.  
   - EnvÃ­a mensajes del usuario a la **Kelly API**.

2. ğŸš€ **Kelly API (FastAPI Backend):**  
   - Recibe peticiones HTTP (`POST /chat`).  
   - Orquesta todo el pipeline de respuesta.  
   - AsÃ­ncrona, rÃ¡pida y escalable.

3. ğŸŒ **Servicios Externos y Bases de Datos:**

   - ğŸ§  **Qdrant (Vector DB):**  
     Base de conocimiento indexada con embeddings y metadatos.  
     â†’ Alimentada por `kelly_indexer`.

   - ğŸ’¬ **LLM API (ej. DeepSeek):**  
     Genera la respuesta final en lenguaje natural, usando el contexto proporcionado.

   - ğŸ—ƒï¸ **MongoDB (Historial - Opcional):**  
     Guarda/retrieved historial de conversaciÃ³n por sesiÃ³n.

4. ğŸ“¦ **Proyectos Relacionados:**
   - `kelly_soap` â†’ Extrae informaciÃ³n y la convierte a JSON Q&A.  
   - `kelly_indexer` â†’ Vectoriza y sube a Qdrant.

### ğŸ” **2.2. Flujo de Procesamiento de Mensajes (RAG Pipeline)**

Cuando un cliente llama al endpoint `POST /api/v1/chat`, Kelly API sigue este flujo:

#### ğŸ“¬ 1. **RecepciÃ³n y ValidaciÃ³n**
- Se recibe un JSON con `message` y `session_id`.
- Se valida estructura + API Key.

#### ğŸ“Œ 2. **Contexto Prioritario (Opcional)**
- Se revisa `priority_context.json`.  
- Si hay coincidencia, se devuelve una respuesta directa.

#### ğŸ§¾ 3. **Historial de Chat (Opcional)**
- Si se activa, se consulta MongoDB para obtener historial por `session_id`.

#### ğŸ§  4. **Embedding de Consulta**
- Se convierte el `message` en un **vector semÃ¡ntico** con Sentence Transformers.

#### ğŸ§² 5. **BÃºsqueda en Qdrant**
- Se recuperan los fragmentos mÃ¡s relevantes usando el vector.  
- Se obtienen `top_k` resultados con `score` y `payload`.

#### ğŸ§· 6. **Formateo de Contexto**
- Se extrae informaciÃ³n Ãºtil de los resultados Qdrant + historial.  
- Se crea un bloque `contexto_formateado` optimizado para el LLM.

#### ğŸ§± 7. **ConstrucciÃ³n del Prompt Final**
- Se une:  
  ğŸ§­ Instrucciones del sistema + ğŸ§µ Contexto + â“ Pregunta del usuario.

#### ğŸ¤– 8. **Llamada al LLM**
- El prompt se envÃ­a a DeepSeek (u otro LLM configurado).

#### ğŸ§¹ 9. **Post-Procesamiento de Respuesta**
- Se limpia la respuesta (remociÃ³n de markdown, emojis, ajustes de estilo).

#### ğŸ—„ï¸ 10. **Guardado en Historial (Opcional)**
- Se guarda pregunta + respuesta final en MongoDB por `session_id`.

#### ğŸ“¤ 11. **ConstrucciÃ³n de la Respuesta Final**
- Se incluye:
  - âœ… Respuesta final (`answer`)  
  - ğŸ“š Fuentes (`sources`) de Qdrant

#### ğŸ“¨ 12. **Respuesta al Cliente**
- Se devuelve la respuesta JSON validada por el schema `ChatResponse`.

### âš™ï¸ **2.3. Servicios Principales (`app/services/`)**

Los servicios estÃ¡n organizados de forma modular en `app/services/`. Cada uno tiene una responsabilidad especÃ­fica:

| ğŸ§© MÃ³dulo                     | ğŸ“ DescripciÃ³n                                                                 |
|------------------------------|-------------------------------------------------------------------------------|
| `rag_pipeline.py`            | Orquestador principal del flujo RAG. Llama a los otros servicios.            |
| `priority_context_service.py`| Busca en FAQs locales (con cachÃ© y similitud).                              |
| `history_service.py`         | (Opcional) Maneja la conexiÃ³n con MongoDB para guardar y leer historial.     |
| `embedding_service.py`       | Convierte textos a embeddings con Sentence Transformers.                     |
| `qdrant_service.py`          | LÃ³gica para buscar documentos en Qdrant usando vectores.                     |
| `llm_service.py`             | Envia prompts y recibe respuestas desde la API del LLM (ej. DeepSeek).       |

## âœ¨ 3. CaracterÃ­sticas Principales

**Kelly API** ha sido diseÃ±ada con un conjunto de funcionalidades modernas que garantizan rendimiento, flexibilidad y escalabilidad como backend para un chatbot inteligente.

### âš¡ **API RESTful con FastAPI (async)**
- âœ… Basada en **FastAPI**, un framework moderno y rÃ¡pido.
- ğŸš€ Manejo eficiente de mÃºltiples conexiones con `async`/`await`.
- ğŸ” Estructura RESTful estandarizada para facilitar integraciÃ³n con clientes (Telegram, web, etc).
### ğŸ§  **Pipeline RAG Configurable**
- ğŸ” Combina recuperaciÃ³n de informaciÃ³n + generaciÃ³n de lenguaje natural.
- âš™ï¸ ParÃ¡metros como `RAG_TOP_K` o `RAG_MAX_CONTEXT_TOKENS` son personalizables desde `.env`.
- ğŸ”„ Permite balancear rendimiento vs. profundidad del anÃ¡lisis.
### ğŸ§² **BÃºsqueda Vectorial en Qdrant**
- ğŸ§¬ Utiliza embeddings para bÃºsquedas semÃ¡nticas.
- ğŸ“¦ ConexiÃ³n con la base Qdrant (`QDRANT_COLLECTION_NAME`) vÃ­a `qdrant-client`.
- ğŸ” Encuentra respuestas relevantes aunque no coincidan textualmente.
### ğŸ¤– **GeneraciÃ³n de Respuestas con LLM (DeepSeek)**
- ğŸ“¡ InteracciÃ³n vÃ­a API con modelos LLM (como DeepSeek, usando `openai`).
- ğŸ§¾ Se envÃ­a un prompt con contexto + historial + personalidad de â€œKelyâ€.
- ğŸ—£ï¸ El resultado: respuestas naturales, empÃ¡ticas y basadas en informaciÃ³n real.
### ğŸ“ **Contexto Prioritario Local (Opcional)**
- âš¡ Revisa `data/priority_context.json` antes de ejecutar el pipeline RAG.
- ğŸ§  Ideal para preguntas frecuentes y respuestas instantÃ¡neas.
- ğŸ’¸ Ahorra recursos del LLM en casos simples.
### ğŸ’¬ **Historial de ConversaciÃ³n (Opcional, MongoDB)**
- ğŸ§µ Guarda mensajes anteriores por sesiÃ³n (`session_id`).
- ğŸ—‚ï¸ Recupera historial usando `langchain-mongodb`.
- ğŸ§  Permite respuestas mÃ¡s contextualizadas y coherentes.
### ğŸ’¡ **Embeddings en Tiempo Real (CPU/GPU)**
- ğŸ“ Convierte preguntas en vectores semÃ¡nticos usando `sentence-transformers`.
- âš™ï¸ Detecta automÃ¡ticamente hardware disponible (`EMBEDDING_DEVICE='auto'`).
- ğŸ§  Acelera procesos con GPU si estÃ¡ disponible (CUDA).
### ğŸ” **AutenticaciÃ³n con API Key (Bearer Token)**
- ğŸ”’ Los endpoints estÃ¡n protegidos con autenticaciÃ³n por token.
- ğŸ›¡ï¸ Se requiere enviar `Authorization: Bearer <token>` en las cabeceras.
- ğŸ—ï¸ Clave definida en `.env` (`API_ACCESS_KEY`).
### âš™ï¸ **ConfiguraciÃ³n Centralizada (.env)**
- ğŸ“‹ ParÃ¡metros operativos y secretos estÃ¡n gestionados fuera del cÃ³digo.
- âœ… ValidaciÃ³n automÃ¡tica mediante `pydantic-settings`.
- ğŸ§ª Permite mÃºltiples entornos: desarrollo, staging, producciÃ³n.
### ğŸ“‘ **DocumentaciÃ³n AutomÃ¡tica (Swagger UI / ReDoc)**
- ğŸ” Autogenerada por FastAPI + Pydantic.
- ğŸ§­ Explorable desde `/api/v1/docs` (Swagger) y `/api/v1/redoc` (ReDoc).
- ğŸ§ª Ideal para pruebas y debugging desde el navegador.
### ğŸ§± **Estructura Modular y Escalable**
- ğŸ§© CÃ³digo organizado por mÃ³dulos: servicios, endpoints, esquemas, config.
- ğŸ”„ Facilita mantenimiento, testing y futuras extensiones.
- ğŸ’¼ Compatible con prÃ¡cticas de desarrollo profesional.
### ğŸ“ **Logging Configurable**
- ğŸ“Š Soporta niveles de log (`DEBUG`, `INFO`, etc.) vÃ­a `.env`.
- ğŸ§¾ Logs opcionalmente redirigibles a archivo (`API_LOG_FILE`).
- ğŸ› ï¸ Esencial para monitoreo y resoluciÃ³n de errores.
### ğŸ§ª **Listo para Desarrollo y ProducciÃ³n**
- ğŸ’» Modo `reload` en desarrollo con `uvicorn`.
- ğŸ­ Preparado para producciÃ³n con **Gunicorn** + mÃºltiples workers.
- ğŸ§± Compatible con entornos ASGI modernos (Docker, Kubernetes, etc.).

## ğŸ§° 4. Pila TecnolÃ³gica

**Kelly API** se basa en una selecciÃ³n de herramientas modernas del ecosistema Python para ofrecer una soluciÃ³n robusta, rÃ¡pida y escalable. A continuaciÃ³n, se detalla la pila utilizada:
### ğŸ§© **Frameworks Principales**
| ğŸ”§ Herramienta        | ğŸ“ DescripciÃ³n |
|----------------------|----------------|
| **âš¡ FastAPI**        | Framework web asincrÃ³nico de alto rendimiento. ValidaciÃ³n automÃ¡tica con Pydantic y documentaciÃ³n autogenerada. |
| **ğŸ”Œ Uvicorn**        | Servidor ASGI ligero para ejecutar FastAPI. Compatible con desarrollo (`reload`) y producciÃ³n (vÃ­a Gunicorn). |
| **ğŸ“ Pydantic / Pydantic-Settings** | ValidaciÃ³n de esquemas de datos y carga de configuraciÃ³n desde `.env` en `app/core/config.py`. |
### ğŸ” **Motor de RecuperaciÃ³n SemÃ¡ntica (RAG)**
| ğŸ§  Componente            | ğŸ” Rol clave en el pipeline |
|--------------------------|------------------------------|
| **ğŸ“¦ Qdrant-Client**      | Cliente oficial para conexiÃ³n asÃ­ncrona a la base vectorial Qdrant. |
| **ğŸ§¬ Sentence-Transformers** | GeneraciÃ³n de embeddings a partir de preguntas. |
| **ğŸ”¥ PyTorch (Torch)**     | Motor de deep learning para ejecutar `sentence-transformers`. Soporte para GPU (CUDA). |
| **ğŸ“Š NumPy**              | LibrerÃ­a numÃ©rica para manejo de arrays de embeddings. |
### ğŸ¤– **InteracciÃ³n con LLM (GeneraciÃ³n de Respuestas)**
| ğŸ§  TecnologÃ­a          | ğŸš€ PropÃ³sito |
|------------------------|--------------|
| **ğŸ“¡ OpenAI (DeepSeek compatible)** | Cliente para enviar prompts y recibir respuestas del LLM configurado. Usa `AsyncOpenAI`. |
| **ğŸ§± Langchain-Core (opcional)** | Estructuras comunes como `BaseMessage` y `Document` usadas para compatibilidad entre servicios. |
### ğŸ—‚ï¸ **GestiÃ³n de Historial (Opcional)**
| ğŸ—ƒï¸ TecnologÃ­a                  | ğŸ’¬ DescripciÃ³n |
|------------------------------|----------------|
| **ğŸ§µ Langchain-MongoDB**       | Clase `MongoDBChatMessageHistory` para almacenar diÃ¡logos por sesiÃ³n. |
| **ğŸ”Œ Pymongo**                | Driver base para conexiÃ³n MongoDB local o Atlas. Usado por `history_service.py`. |
### ğŸ§¾ **Procesamiento de Texto y Chunking (Opcional)**
| ğŸ§  LibrerÃ­a                    | âœ‚ï¸ FunciÃ³n |
|-------------------------------|------------|
| **ğŸ“š Langchain-Text-Splitters** | Divide textos largos de Qdrant en fragmentos procesables para el LLM. Usado por `text_chunker.py`. |
### ğŸ§ª **Testing y Desarrollo**
| ğŸ§ª Herramienta        | ğŸ§° Uso especÃ­fico |
|------------------------|------------------|
| **ğŸŒ HTTPX**           | Cliente HTTP asÃ­ncrono para pruebas de endpoints (`tests/conftest.py`). |
| **ğŸ§ª Pytest**          | Framework principal para pruebas unitarias e integraciÃ³n. |
| **ğŸ”Œ Plugins Pytest:** `pytest-asyncio`, `pytest-cov`, `pytest-mock` | Pruebas async, cobertura de cÃ³digo, mocks. |
### ğŸ§¹ **Calidad de CÃ³digo**
| ğŸ§¼ Herramienta     | ğŸ§¾ FunciÃ³n |
|--------------------|------------|
| **âš¡ Ruff**         | Linter rÃ¡pido con reglas personalizables. |
| **ğŸ¨ Black**        | Formateador de cÃ³digo estilo uniforme. |
| **ğŸ” MyPy**         | Verificador estÃ¡tico de tipos para prevenir errores antes de runtime. |
Esta pila tÃ©cnica ha sido elegida para garantizar que **Kelly API** sea:  
âœ… RÃ¡pida  
âœ… Mantenible  
âœ… Extensible  
âœ… Escalable  

## ğŸ§¾ 5. Prerrequisitos

Antes de instalar y ejecutar **Kelly API**, asegÃºrate de tener el entorno adecuado, los servicios externos disponibles y las credenciales necesarias. Esta preparaciÃ³n es fundamental para un despliegue exitoso.
### ğŸ–¥ï¸ **5.1. Software Requerido**

AsegÃºrate de tener el siguiente software en tu entorno de desarrollo (especialmente si usas **WSL2**):
| ğŸ“¦ Software        | ğŸ“ DescripciÃ³n |
|--------------------|----------------|
| **ğŸ Python 3.10+** | Requerido para caracterÃ­sticas modernas del lenguaje y tipado estÃ¡tico. Verifica con `python --version`. |
| **ğŸ§ª Conda / Miniconda** | Recomendado para crear entornos virtuales aislados. Alternativa: `venv`. |
| **ğŸ”§ Git**          | Necesario para clonar el repositorio del proyecto. |
ğŸ”¸ *Nota para usuarios de WSL:* AsegÃºrate de que tu sistema WSL2 tenga acceso a red y (si aplica) a GPU para procesamiento con CUDA.

### ğŸŒ **5.2. Servicios Externos y Datos**
La API depende de varios servicios externos. Estos deben estar activos y accesibles:

#### ğŸ“š **Qdrant (Base Vectorial)**
- ğŸ§  Contiene los datos recuperables por embeddings.
- âš ï¸ **Debe existir previamente** y estar poblada por `kelly_indexer`.
- ğŸ”— Configura: `QDRANT_URL`, `QDRANT_COLLECTION_NAME`.

#### ğŸ¤– **API del LLM Generativo (ej. DeepSeek)**
- ğŸ“¡ Necesitas una API Key vÃ¡lida y acceso al endpoint: `DEEPSEEK_BASE_URL`.

#### ğŸ—„ï¸ **MongoDB (Opcional - Historial)**
- ğŸ—‚ï¸ Usado solo si activas la funcionalidad de historial.
- ğŸ”‘ Configura con `MONGO_URI` (cadena de conexiÃ³n completa).

### ğŸ” **5.3. Credenciales Necesarias**
Estas claves deben almacenarse de forma **segura** en tu archivo `.env`:
| ğŸ”‘ Variable              | ğŸ§¾ DescripciÃ³n |
|--------------------------|----------------|
| **`API_ACCESS_KEY`**      | Clave secreta para acceder a tu API. Los clientes deben enviarla como `Authorization: Bearer <token>`. |
| **`DEEPSEEK_API_KEY`**    | Clave de acceso al modelo LLM (DeepSeek u otro). Obligatoria para la generaciÃ³n de respuestas. |
| **`QDRANT_API_KEY`**      | (Opcional) Requerida si usas Qdrant Cloud con autenticaciÃ³n. |
| **`MONGO_URI`**           | (Opcional) Cadena de conexiÃ³n a tu base de datos MongoDB. |
ğŸ“Œ **Importante:** Estas variables son sensibles. No las compartas pÃºblicamente y mantenlas fuera del control de versiones (usa `.gitignore` para excluir tu `.env`).

## ğŸ› ï¸ 6. InstalaciÃ³n

Sigue estos pasos para configurar y ejecutar **Kelly API** localmente. Se asume que ya tienes un entorno tipo **Linux** (ej. **WSL2**) y que cumpliste los prerrequisitos.

### ğŸ”„ **6.1. Clonar el Repositorio**
1. Abre tu terminal.
2. Navega al directorio donde quieras clonar el proyecto.
3. Ejecuta:
```bash
git clone <URL_DEL_REPOSITORIO_KELLY_API>
cd kelly_api
```
ğŸ“ Este directorio serÃ¡ la raÃ­z para todos los comandos siguientes.

### ğŸ **6.2. Crear y Activar Entorno Conda**
Crea un entorno aislado para evitar conflictos de dependencias:
```bash
conda create --name kelly_api_env python=3.10 -y
conda activate kelly_api_env
```

ğŸ”” VerÃ¡s el prompt cambiar a `(kelly_api_env)`.  
ğŸ” *Recuerda activarlo cada vez que trabajes en el proyecto.*

### ğŸ“¦ **6.3. Instalar Dependencias del Proyecto**
Desde la raÃ­z del proyecto, instala las dependencias principales, de desarrollo y de pruebas:
```bash
pip install -e .[dev,test]
```
ğŸ“Œ Esto instalarÃ¡ automÃ¡ticamente:
- Dependencias de runtime
- Herramientas de testing (`pytest`, `httpx`)
- Linters y formatters (`ruff`, `black`)
- Soporte async (`pytest-asyncio`, etc.)

### âš¡ **6.4. (Opcional) Instalar PyTorch con CUDA para GPU**
Si cuentas con una **GPU NVIDIA** + **CUDA en WSL2**, puedes acelerar la generaciÃ³n de embeddings:
1. Ve a ğŸ‘‰ [https://pytorch.org/get-started/locally/](https://pytorch.org/get-started/locally/)
2. Selecciona:  
   - **Stable**  
   - **Linux**  
   - **Pip o Conda**  
   - **CUDA** segÃºn tu instalaciÃ³n (ej. CUDA 12.1)
3. Copia y ejecuta el comando sugerido en tu terminal:
```bash
# âš ï¸ Solo ejemplo. Usa el comando actualizado desde el sitio oficial
pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
```
ğŸ Esto instalarÃ¡ una versiÃ³n de **PyTorch con soporte GPU**.
> ğŸ’¡ Si no tienes GPU o prefieres no usar CUDA, PyTorch usarÃ¡ CPU automÃ¡ticamente.
âœ… Con esto ya tendrÃ¡s:
- El cÃ³digo del proyecto
- Un entorno virtual activo (`kelly_api_env`)
- Todas las librerÃ­as instaladas
- (Opcionalmente) PyTorch optimizado con GPU
ğŸŸ¢ El siguiente paso es configurar el archivo `.env` para conectar los servicios externos y establecer las credenciales.

## âš™ï¸ 7. ConfiguraciÃ³n (`.env`)
**Kelly API** utiliza un archivo `.env` para gestionar toda su configuraciÃ³n sensible y dependiente del entorno. Esto permite separar el cÃ³digo fuente de los secretos y adaptar la aplicaciÃ³n fÃ¡cilmente a distintos entornos (dev, staging, producciÃ³n).

### ğŸ“ **7.1. Crear el archivo `.env` (desde `.env.sample`)**
1. Copia la plantilla:
```bash
cp .env.sample .env
```
2. Abre `.env` en tu editor favorito:
```bash
nano .env
```
3. Reemplaza los valores de ejemplo con tus datos reales.  
   ğŸ” Â¡No compartas este archivo!

### ğŸ§¾ **7.2. Variables de Entorno (Explicadas)**
#### ğŸ–¥ï¸ **Servidor API**
| Variable         | DescripciÃ³n |
|------------------|-------------|
| `API_HOST`       | DirecciÃ³n IP (ej: `0.0.0.0`, `127.0.0.1`) |
| `API_PORT`       | Puerto donde escucha la API (default: `8000`) |
| `LOG_LEVEL`      | Nivel de logging (`DEBUG`, `INFO`, etc.) |
| `API_LOG_FILE`   | (Opcional) Ruta para guardar logs |
| `API_RELOAD`     | `true/false` para recarga automÃ¡tica (dev only) |
#### ğŸ” **Seguridad de la API**
| Variable           | DescripciÃ³n |
|--------------------|-------------|
| `API_ACCESS_KEY`   | âœ… **Obligatoria.** Clave que los clientes deben usar (`Bearer <token>`) |
#### ğŸ¤– **LLM Generativo (DeepSeek)**
| Variable              | DescripciÃ³n |
|------------------------|-------------|
| `DEEPSEEK_API_KEY`     | âœ… Clave API del proveedor LLM |
| `DEEPSEEK_BASE_URL`    | URL del endpoint (default: DeepSeek oficial) |
| `DEEPSEEK_MODEL_NAME`  | Nombre del modelo (ej: `deepseek-chat`) |
| `LLM_REQUEST_TIMEOUT`  | Tiempo mÃ¡ximo de espera por respuesta (default: `120.0`) |
#### ğŸ“š **Qdrant (Base Vectorial)**
| Variable               | DescripciÃ³n |
|------------------------|-------------|
| `QDRANT_URL`           | âœ… URL completa de tu instancia Qdrant |
| `QDRANT_API_KEY`       | (Opcional) Clave si usas Qdrant Cloud |
| `QDRANT_COLLECTION_NAME` | Nombre de la colecciÃ³n usada por `kelly_indexer` |
| `DISTANCE_METRIC`      | MÃ©trica usada (`Cosine`, `Dot`, `Euclid`) |
#### ğŸ§¬ **Modelo de Embeddings**
| Variable              | DescripciÃ³n |
|------------------------|-------------|
| `EMBEDDING_MODEL_NAME` | Modelo de `sentence-transformers` (ej: `intfloat/multilingual-e5-base`) |
| `VECTOR_DIMENSION`     | DimensiÃ³n del vector (ej: `768`) |
| `EMBEDDING_DEVICE`     | `auto`, `cuda` o `cpu` |
#### ğŸ—ƒï¸ **MongoDB (Historial - Opcional)**
| Variable                 | DescripciÃ³n |
|--------------------------|-------------|
| `MONGO_URI`              | URI completa (con credenciales si aplica) |
| `MONGO_DATABASE_NAME`    | Default: `kellybot_chat` |
| `MONGO_COLLECTION_NAME`  | Default: `chat_histories` |
#### âš¡ **Contexto Prioritario (Opcional)**
| Variable                      | DescripciÃ³n |
|-------------------------------|-------------|
| `PRIORITY_CONTEXT_FILE_PATH`  | Ruta al JSON de respuestas rÃ¡pidas |
| `PRIORITY_SIMILARITY_THRESHOLD` | Umbral de similitud (default: `0.85`) |
#### ğŸ§  **ParÃ¡metros del Pipeline RAG**
| Variable                   | DescripciÃ³n |
|----------------------------|-------------|
| `RAG_TOP_K`                | NÃºmero de documentos a recuperar (ej: `3`) |
| `RAG_MAX_CONTEXT_TOKENS`   | LÃ­mite de tokens para el prompt del LLM (ej: `3000`) |

### ğŸš« **7.3. Seguridad: Ignorar `.env` con Git**
AsegÃºrate de que tu archivo `.env` **NO se suba nunca al repositorio**.  
Incluye esta lÃ­nea en `.gitignore`:
```bash
.env
```
ğŸ”’ **Solo el archivo `.env.sample` debe estar en el repo.**  
AsÃ­ tus secretos se mantienen privados y tus colaboradores tienen una guÃ­a de configuraciÃ³n.

## ğŸš€ 8. EjecuciÃ³n de la API
Una vez que hayas instalado el proyecto y configurado tu archivo `.env`, puedes iniciar el servidor de **Kelly API** usando **Uvicorn** o **Gunicorn**, dependiendo de si estÃ¡s en desarrollo o producciÃ³n.
ğŸ”” AsegÃºrate de tener tu entorno **`kelly_api_env` activado** y de estar ubicado en la carpeta raÃ­z del proyecto.

### ğŸ§ª **8.1. Modo Desarrollo (Con Recarga AutomÃ¡tica)**
Este modo es ideal para desarrollar y testear la API, ya que **reinicia automÃ¡ticamente el servidor** al detectar cambios.
#### â–¶ï¸ OpciÃ³n 1: Uvicorn directo (recomendado)
```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```
ğŸ“Œ Detalles:
- `--reload`: Recarga automÃ¡tica al guardar cambios.
- `--host`: Acepta conexiones desde cualquier interfaz.
- `--port`: Puerto en el que correrÃ¡ la API.
#### â–¶ï¸ OpciÃ³n 2: Script personalizado
```bash
python scripts/run_api.py
```
Este mÃ©todo usa las variables del `.env` como `API_HOST`, `API_PORT`, y `API_RELOAD`.
ğŸ”§ Requiere que `API_RELOAD=true` estÃ© definido en el archivo `.env` y gestionado en `config.py`.

### ğŸ­ **8.2. Modo ProducciÃ³n (Con Gunicorn)**
Para producciÃ³n, utiliza **Gunicorn** con workers asincrÃ³nicos para mejorar rendimiento y escalabilidad.
#### ğŸ“¥ Instala Gunicorn (si no lo tienes)
```bash
pip install gunicorn
```
#### â–¶ï¸ Ejecuta con mÃºltiples workers:
```bash
gunicorn -k uvicorn.workers.UvicornWorker -w 4 -b 0.0.0.0:8000 app.main:app
```
ğŸ“Œ ParÃ¡metros explicados:
- `-k`: Worker especializado de Uvicorn (ASGI).
- `-w 4`: NÃºmero de workers (usa mÃ¡s si tienes mÃ¡s nÃºcleos).
- `-b`: DirecciÃ³n IP y puerto de escucha.
- `app.main:app`: Punto de entrada (FastAPI app).

> âš™ï¸ RecomendaciÃ³n: Combinar con `systemd`, `nginx` o Docker para despliegues completos.

### ğŸ” **8.3. VerificaciÃ³n de Inicio**
Al ejecutar la API, deberÃ­as ver logs como:
```
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     Started server process [xxxxx]
INFO:     --- Iniciando KellyBot API (Lifespan) ---
INFO:     Host: 0.0.0.0, Puerto: 8000, LogLevel: INFO
INFO:     --- KellyBot API Iniciada y Lista (Lifespan) ---
```
âœ… Si no ves errores `ERROR` o `CRITICAL`, el arranque fue exitoso.  
ğŸŒ Prueba la API en tu navegador:  
[http://localhost:8000/api/v1/docs](http://localhost:8000/api/v1/docs)

### ğŸ›‘ **8.4. Detener el Servidor**
Presiona `Ctrl + C` en la terminal para detener el servidor.  
ğŸ” Puede requerir presionarlo dos veces si hay tareas pendientes.



**9. Uso de la API**
Esta secciÃ³n describe cÃ³mo los desarrolladores de aplicaciones cliente (como bots, interfaces web, etc.) pueden interactuar con la API KellyBot una vez que estÃ© corriendo.

**9.1. AutenticaciÃ³n (Cabecera `Authorization: Bearer <API_ACCESS_KEY>`)**
La seguridad es primordial. Los endpoints principales de la API KellyBot, en particular el endpoint `/api/v1/chat`, estÃ¡n protegidos y requieren autenticaciÃ³n mediante una clave API. Los clientes que deseen utilizar estos endpoints deben incluir una cabecera HTTP `Authorization` en cada una de sus peticiones.
El formato requerido para esta cabecera sigue el estÃ¡ndar **Bearer Token**:
```
Authorization: Bearer <TU_API_ACCESS_KEY_REAL>
```
Donde `<TU_API_ACCESS_KEY_REAL>` debe ser reemplazado por la clave secreta que se configurÃ³ en la variable `API_ACCESS_KEY` dentro del archivo `.env` del servidor de la API KellyBot. Esta es la clave que el administrador de la API debe generar y compartir de forma segura con los desarrolladores de las aplicaciones cliente autorizadas.

Cualquier peticiÃ³n a un endpoint protegido que no incluya esta cabecera, o que incluya una clave invÃ¡lida o con formato incorrecto, recibirÃ¡ una respuesta de error `401 Unauthorized`.
**9.2. Endpoints Disponibles**
La API ofrece los siguientes puntos de entrada principales:
* **`POST /api/v1/chat`**
    * **PropÃ³sito:** Este es el endpoint central para la funcionalidad del chatbot. Recibe el mensaje del usuario y el identificador de su sesiÃ³n, ejecuta todo el pipeline RAG (Retrieval-Augmented Generation) â€“ incluyendo la consulta opcional a contexto prioritario e historial, la bÃºsqueda semÃ¡ntica en Qdrant y la generaciÃ³n final de respuesta con el LLM (DeepSeek) â€“ y devuelve la respuesta del asistente junto con las fuentes de informaciÃ³n consultadas.
    * **Request Body (Cuerpo de la PeticiÃ³n):** Se espera un payload en formato JSON que cumpla con el schema `ChatRequest`. Debe contener obligatoriamente los siguientes campos:
        * `message` (string): La pregunta o texto enviado por el usuario. No debe estar vacÃ­o.
        * `session_id` (string): Un identificador Ãºnico que representa la sesiÃ³n de conversaciÃ³n actual del usuario. Es esencial para funcionalidades futuras como el historial.
        * *Ejemplo de JSON vÃ¡lido:*
            ```json
            {
              "message": "Â¿CuÃ¡les son los requisitos de sistema para MiAdminXML?",
              "session_id": "userXYZ-session12345"
            }
            ```
    * **Response Body Exitoso (CÃ³digo 200 OK):** Si la peticiÃ³n es vÃ¡lida y el procesamiento es exitoso, la API devuelve un payload JSON que cumple con el schema `ChatResponse`. Contiene los siguientes campos:
        * `answer` (string): La respuesta final generada por el LLM, ya post-procesada.
        * `sources` (lista de objetos): Una lista que contiene informaciÃ³n sobre los documentos o FAQs recuperados de Qdrant que se usaron como contexto principal para generar la respuesta. Cada objeto en la lista sigue el schema `SourceInfo` e incluye:
            * `source_id` (string): El identificador Ãºnico de la fuente (generalmente el `faq_id` original o el UUID del punto en Qdrant).
            * `score` (float, opcional): La puntuaciÃ³n de similitud devuelta por Qdrant (mÃ¡s alta indica mayor relevancia).
        * `session_id` (string): El mismo ID de sesiÃ³n que se enviÃ³ en la peticiÃ³n, devuelto para referencia.
        * *Ejemplo de JSON de respuesta exitosa:*
            ```json
            {
              "answer": "MiAdminXML requiere Windows 10 u 11 de 64 bits, 4 GB de RAM y conexiÃ³n a internet. Se recomienda un procesador Core i3 o superior y disco SSD.",
              "sources": [
                {
                  "source_id": "SYS-REQ-XML-01_q0",
                  "score": 0.915
                }
              ],
              "session_id": "userXYZ-session12345"
            }
            ```
    * **Respuestas de Error Comunes:**
        * `401 Unauthorized`: La cabecera `Authorization` falta, estÃ¡ mal formada o la clave API (`API_ACCESS_KEY`) es incorrecta.
        * `422 Unprocessable Entity`: El cuerpo JSON de la peticiÃ³n es invÃ¡lido. Falta el campo `message` o `session_id`, o no son del tipo esperado (string). El cuerpo de la respuesta del error contendrÃ¡ detalles especÃ­ficos sobre quÃ© campo fallÃ³ la validaciÃ³n.
        * `500 Internal Server Error`: OcurriÃ³ un error inesperado en el servidor mientras se procesaba la peticiÃ³n (ej. fallo al conectar con Qdrant, error en la API del LLM, un bug en el cÃ³digo del pipeline RAG). La respuesta puede contener un mensaje genÃ©rico; se deben revisar los logs del servidor API para obtener el detalle tÃ©cnico del error.
* **`GET /`**
    * **PropÃ³sito:** Es un endpoint raÃ­z simple, Ãºtil para verificar rÃ¡pidamente si la instancia de la API estÃ¡ en lÃ­nea y respondiendo a peticiones HTTP bÃ¡sicas. A menudo se usa como un health check muy elemental.
    * **Response Body Exitoso (200 OK):** Devuelve un objeto JSON simple definido por el schema `StatusResponse`, indicando que la API estÃ¡ operativa.
        * *Ejemplo:* `{"status": "ok", "message": "KellyBot API (v1) estÃ¡ operativa."}`
* **`GET /health`**
    * **PropÃ³sito:** Similar al endpoint raÃ­z, pero especÃ­ficamente diseÃ±ado para sistemas de monitoreo automatizado (como probes de Kubernetes, balanceadores de carga, etc.). Verifica que la aplicaciÃ³n FastAPI estÃ© saludable y pueda procesar peticiones. Por defecto, no aparece en la documentaciÃ³n pÃºblica de OpenAPI/Swagger.
    * **Response Body Exitoso (200 OK):** Devuelve un objeto JSON simple `StatusResponse`.
        * *Ejemplo:* `{"status": "ok", "message": "API healthy."}`
        * *Nota:* En futuras versiones, este endpoint podrÃ­a incluir verificaciones mÃ¡s profundas (ej. conectividad con Qdrant y LLM) para dar un estado de salud mÃ¡s preciso.

**9.3. Acceso a la DocumentaciÃ³n Interactiva (Swagger UI / ReDoc)**
Una gran ventaja de usar FastAPI es la generaciÃ³n automÃ¡tica de documentaciÃ³n interactiva basada en el estÃ¡ndar OpenAPI. Una vez que el servidor API estÃ© corriendo (por defecto en `http://localhost:8000`), puedes acceder a estas interfaces desde tu navegador web:
* **Swagger UI:** Navega a `http://localhost:8000/api/v1/docs`. AquÃ­ encontrarÃ¡s una lista de todos los endpoints disponibles (excepto los marcados como `include_in_schema=False` como `/health`), podrÃ¡s ver los schemas de peticiÃ³n y respuesta (`ChatRequest`, `ChatResponse`, etc.), y podrÃ¡s **enviar peticiones de prueba** directamente desde la interfaz (recuerda configurar la autenticaciÃ³n Bearer Token usando el botÃ³n "Authorize" si pruebas endpoints protegidos como `/chat`).
* **ReDoc:** Navega a `http://localhost:8000/api/v1/redoc`. Ofrece una vista alternativa y mÃ¡s enfocada en la documentaciÃ³n de los mismos endpoints y schemas.
Estas herramientas son extremadamente Ãºtiles tanto para los desarrolladores que consumen la API como para los que la desarrollan y prueban.
Â¡Entendido! AquÃ­ tienes la descripciÃ³n detallada en prosa para la secciÃ³n **Estructura del Proyecto** de tu `README.md`. Aunque un diagrama visual

## ğŸ§± 10. Estructura del Proyecto

El proyecto `kelly_api` sigue una arquitectura modular clara, alineada con las **buenas prÃ¡cticas de FastAPI**. EstÃ¡ diseÃ±ado para facilitar la **mantenibilidad, escalabilidad** y la colaboraciÃ³n entre equipos.

### ğŸ—‚ï¸ Estructura de Carpetas
```
kelly_api/
â”œâ”€â”€ .env                  â† ConfiguraciÃ³n sensible (NO subir)
â”œâ”€â”€ .env.sample           â† Plantilla del archivo .env
â”œâ”€â”€ .gitignore            â† Exclusiones para Git
â”œâ”€â”€ pyproject.toml        â† Dependencias y config del proyecto
â”œâ”€â”€ README.md             â† DocumentaciÃ³n principal
â”œâ”€â”€ LICENSE               â† Licencia del proyecto
â”œâ”€â”€ app/                  â† CÃ³digo fuente principal de la API
â”‚   â”œâ”€â”€ main.py           â† Punto de entrada de FastAPI
â”‚   â”‚
â”‚   â”œâ”€â”€ api/              â† Routers, endpoints y dependencias
â”‚   â”‚   â”œâ”€â”€ deps.py           â† Funciones compartidas (`Depends`)
â”‚   â”‚   â””â”€â”€ v1/               â† VersiÃ³n 1 de la API
â”‚   â”‚       â”œâ”€â”€ api.py            â† Router agregador
â”‚   â”‚       â””â”€â”€ endpoints/
â”‚   â”‚           â”œâ”€â”€ chat.py        â† Endpoint POST /chat
â”‚   â”‚           â””â”€â”€ status.py      â† Endpoints / y /health
â”‚   â”‚
â”‚   â”œâ”€â”€ core/             â† ConfiguraciÃ³n y seguridad
â”‚   â”‚   â”œâ”€â”€ config.py         â† Clase Settings (.env)
â”‚   â”‚   â””â”€â”€ security.py       â† ValidaciÃ³n de API Key
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/          â† Modelos Pydantic
â”‚   â”‚   â”œâ”€â”€ chat.py           â† `ChatRequest`, `ChatResponse`
â”‚   â”‚   â””â”€â”€ status.py         â† `StatusResponse`
â”‚   â”‚
â”‚   â””â”€â”€ services/         â† LÃ³gica de negocio y acceso a datos
â”‚       â”œâ”€â”€ rag_pipeline.py       â† Orquestador RAG
â”‚       â”œâ”€â”€ embedding_service.py  â† Embeddings con Transformers
â”‚       â”œâ”€â”€ qdrant_service.py     â† ConexiÃ³n a Qdrant
â”‚       â”œâ”€â”€ llm_service.py        â† ConexiÃ³n a LLM (DeepSeek)
â”‚       â”œâ”€â”€ priority_context_service.py â† FAQs locales
â”‚       â””â”€â”€ history_service.py    â† Historial en MongoDB (opcional)
â”œâ”€â”€ data/                 â† Archivos de datos locales
â”‚   â””â”€â”€ priority_context.json     â† Contexto prioritario FAQ
â”œâ”€â”€ scripts/              â† Scripts auxiliares
â”‚   â””â”€â”€ run_api.py        â† Inicia el servidor Uvicorn
â””â”€â”€ tests/                â† Pruebas automatizadas
    â”œâ”€â”€ conftest.py           â† Fixtures de prueba
    â”œâ”€â”€ api/                  â† Pruebas de endpoints
    â”œâ”€â”€ core/
    â”œâ”€â”€ schemas/
    â””â”€â”€ services/
```

### ğŸ§  DescripciÃ³n de Componentes
#### ğŸ“ `app/`
- **`main.py`**: Inicializa la instancia de FastAPI y configura el ciclo de vida de la app.
- **`api/`**: Define y agrupa los endpoints. Soporta versionamiento (v1, v2...).
- **`core/`**: ConfiguraciÃ³n global, carga de `.env`, seguridad, etc.
- **`schemas/`**: Modelos Pydantic para validar y documentar requests/responses.
- **`services/`**: LÃ³gica del negocio: embedding, RAG, acceso a Qdrant/LLM/Mongo.
#### ğŸ“ `data/`
- Archivos JSON u otros recursos locales. Ejemplo: contexto FAQ prioritario.
#### ğŸ“ `scripts/`
- Scripts CLI o de automatizaciÃ³n. `run_api.py` arranca la API con lectura de `.env`.
#### ğŸ“ `tests/`
- OrganizaciÃ³n paralela a `app/`, siguiendo la misma estructura para testeo modular.
#### ğŸ“„ `pyproject.toml`
- GestiÃ³n de dependencias (`[project.dependencies]`, `[dev]`, `[test]`)
- Configura herramientas como `ruff`, `pytest`, `black`.
#### ğŸ“„ `.env` / `.env.sample`
- `.env`: Variables reales de entorno (no subir a Git).
- `.env.sample`: Plantilla editable para configurar nuevos entornos.

### âœ… Ventajas de esta estructura
- ğŸ” **Modular y clara**: FÃ¡cil de navegar.
- ğŸ§ª **Lista para testing**: Soporte nativo para pruebas unitarias e integraciÃ³n.
- ğŸ” **Escalable**: Soporta mÃºltiples versiones de la API y nuevos servicios.
- ğŸ“¦ **Listo para producciÃ³n**: Compatible con Gunicorn, Docker, etc.

## ğŸ§ª 11. Pruebas Unitarias y de IntegraciÃ³n

**Kelly API** incluye un sistema de pruebas automatizadas con **Pytest**, diseÃ±ado para garantizar la calidad del cÃ³digo, validar el comportamiento de los endpoints y asegurar la integridad del pipeline RAG ante cambios.

### âš™ï¸ **11.1. ConfiguraciÃ³n en `pyproject.toml`**
La configuraciÃ³n de Pytest se encuentra en el archivo `pyproject.toml`, bajo `[tool.pytest.ini_options]`.
#### ğŸ”§ Opciones destacadas:
| Clave                         | DescripciÃ³n |
|------------------------------|-------------|
| `minversion = "7.0"`         | Pytest 7 o superior. |
| `addopts`                    | Argumentos por defecto:<br>`-ra -q --cov=app --cov-report=term-missing` |
| `testpaths = ["tests"]`      | Directorio donde Pytest buscarÃ¡ pruebas. |
| `asyncio_mode = "auto"`      | Soporte automÃ¡tico para pruebas `async`. |

ğŸ“Œ **Cobertura activada por defecto** gracias a `pytest-cov`.

### â–¶ï¸ **11.2. CÃ³mo Ejecutar las Pruebas**
#### ğŸ§± Paso a paso:
```bash
conda activate kelly_api_env         # Activa entorno
pip install -e .[dev,test]          # Asegura dependencias
cd kelly_api/                       # Ir al directorio raÃ­z del proyecto
pytest                              # Ejecutar todas las pruebas
```
#### ğŸ¯ EjecuciÃ³n avanzada:
| AcciÃ³n                          | Comando |
|--------------------------------|---------|
| Ejecutar un solo archivo       | `pytest tests/services/test_rag_pipeline.py` |
| Filtrar por nombre             | `pytest -k "test_chat_endpoint_success"` |
| Mostrar prints en terminal     | `pytest -s` |
| Parar tras primer fallo        | `pytest -x` |
| Reintentar Ãºltimas fallidas    | `pytest --lf` |

### ğŸ“ˆ **11.3. Cobertura de CÃ³digo**
DespuÃ©s de ejecutar las pruebas, verÃ¡s algo como:
```
Name                          Stmts   Miss  Cover   Missing
-----------------------------------------------------------
app/rag_pipeline.py             80     10    87%     34-40
app/embedding_service.py        50      4    92%     18, 29-31
...
-----------------------------------------------------------
TOTAL                          450     35    92%
```
- âœ… Alta cobertura = mayor confianza.
- ğŸ§­ `term-missing` te muestra quÃ© lÃ­neas no fueron cubiertas.

### ğŸ§ª **11.4. Mocking de Servicios Externos**
Para pruebas efectivas, **no se debe depender de Qdrant, LLM o MongoDB en vivo**. Usa **mocking** con `pytest-mock`.
#### ğŸ§° Herramientas:
- `unittest.mock`
- `pytest-mock` (`mocker` fixture)
#### âœ… Ejemplos comunes:
| Contexto                         | QuÃ© se mockea                                         |
|----------------------------------|--------------------------------------------------------|
| `test_chat.py` (endpoint)        | `rag_pipeline.generate_response`                      |
| `test_rag_pipeline.py` (servicio)| `embedding_service.embed_query` <br> `qdrant_service.search_documents` <br> `llm_service.call_llm` |
#### ğŸ”§ Ejemplo bÃ¡sico:
```python
mocker.patch("app.services.rag_pipeline.generate_response", return_value=MockResponse)
```
ğŸ’¡ El mocking permite simular:
- Respuestas de Ã©xito
- Errores de conexiÃ³n
- Datos vacÃ­os
- Comportamientos no determinÃ­sticos
### âœ… Beneficios del sistema de pruebas
- ğŸ”„ Ejecutables en segundos, sin dependencias externas.
- ğŸ“‰ Reduce riesgo de regresiones.
- ğŸ‘¨â€ğŸ’» Mejora el ciclo de desarrollo (test-driven).
- ğŸ§ª Ideal para CI/CD y despliegues automÃ¡ticos.

## ğŸ§¯ 12. SoluciÃ³n de Problemas Comunes
Durante la configuraciÃ³n, ejecuciÃ³n o consumo de **Kelly API**, podrÃ­as encontrar errores. AquÃ­ se listan los mÃ¡s frecuentes, junto con su causa probable y su soluciÃ³n recomendada.
> ğŸ“¢ **Consejo general:** **Siempre revisa los logs de la terminal.** Es tu mejor herramienta para entender quÃ© estÃ¡ fallando.
### ğŸš« Errores al Iniciar la API
#### â— **ValidationError (al cargar `.env`)**
- **SÃ­ntoma:** 
  ```
  CRITICAL: Validation error for Settings
  QDRANT_URL: field required
  ```
- **Causa:** Falta una o mÃ¡s variables obligatorias en `.env`.
- **SoluciÃ³n:** Verifica que `.env` contenga:
  - `QDRANT_URL`
  - `DEEPSEEK_API_KEY`
  - `API_ACCESS_KEY`
  - Sin errores de sintaxis y sin lÃ­neas comentadas accidentalmente.
#### ğŸ§© **ImportError (al importar mÃ³dulos)**
- **SÃ­ntoma:** Error del tipo:
  ```
  ImportError: cannot import name 'FastAPI'
  ```
- **Causa:** Dependencias no instaladas correctamente o problemas con el entorno.
- **SoluciÃ³n:**
  - AsegÃºrate de tener activado `conda activate kelly_api_env`.
  - Reinstala dependencias: `pip install -e .[dev,test]`.
  - Verifica existencia de `__init__.py` en todas las carpetas del paquete.

#### ğŸ”Œ **Address already in use (puerto ocupado)**
- **SÃ­ntoma:**
  ```
  OSError: [Errno 98] Address already in use
  ```
- **Causa:** Otro proceso (quizÃ¡ otra instancia de la API) ya usa ese puerto.
- **SoluciÃ³n:**
  - Mata el proceso en uso: `lsof -i :8000` + `kill <PID>`.
  - O cambia `API_PORT` a otro valor (ej. `8001`) en `.env`.

#### âš ï¸ **Error al cargar modelo de embeddings**
- **SÃ­ntoma:** Error desde `embedding_service.py` o `torch`, `transformers`, CUDA.
- **Causa:** Nombre de modelo mal escrito, falta internet, conflicto de versiones, problema con GPU.
- **SoluciÃ³n:**
  - Verifica `EMBEDDING_MODEL_NAME` en `.env`.
  - Ejecuta `pip list` y confirma instalaciÃ³n de `torch`, `sentence-transformers`.
  - Si usas GPU, revisa drivers y soporte CUDA.

### ğŸŒ Errores durante el uso de la API
#### ğŸ” **401 Unauthorized**
- **SÃ­ntoma:**
  ```
  {"detail": "Not authenticated"}
  ```
- **Causa:** Cabecera `Authorization` ausente o con token incorrecto.
- **SoluciÃ³n:**
  - AsegÃºrate de enviar:
    ```
    Authorization: Bearer TU_API_ACCESS_KEY_REAL
    ```
  - Verifica que coincida exactamente con el valor en el servidor (`.env`).

#### ğŸ§¾ **422 Unprocessable Entity**
- **SÃ­ntoma:** Error al llamar a `POST /api/v1/chat`, con detalles sobre campos invÃ¡lidos.
- **Causa:** JSON mal formado o campos faltantes (`message`, `session_id`).
- **SoluciÃ³n:**
  - AsegÃºrate de enviar:
    ```json
    {
      "message": "Â¿QuÃ© hace MiAdminXML?",
      "session_id": "test-user-001"
    }
    ```
  - Usa Swagger (`/api/v1/docs`) para verificar el esquema correcto.

#### ğŸ§¨ **500 Internal Server Error**
- **SÃ­ntoma:**
  ```json
  {"detail": "OcurriÃ³ un error interno..."}
  ```
- **Causa:** Error inesperado durante el procesamiento: fallos en Qdrant, DeepSeek, MongoDB o bugs internos.
- **SoluciÃ³n:**
  - Revisa logs en terminal.
  - Busca errores como:
    - `ConnectionRefusedError` â†’ Qdrant
    - `AuthenticationError` â†’ LLM
    - `KeyError` o `TypeError` â†’ Bug interno


### ğŸ§  Respuestas del Chatbot que No Son Esperadas
#### ğŸ¤· **Respuesta genÃ©rica o vacÃ­a**
- **SÃ­ntoma:** El bot responde:
  ```
  "Lo siento, no tengo esa informaciÃ³n especÃ­fica..."
  ```
- **Causa:**
  - No se encontrÃ³ contexto Ãºtil en Qdrant.
  - OcurriÃ³ un error controlado con el LLM.
- **SoluciÃ³n:**
  - Verifica que la colecciÃ³n de Qdrant tenga datos relevantes.
  - Aumenta `RAG_TOP_K` o ajusta `PRIORITY_SIMILARITY_THRESHOLD`.
  - Revisa logs para confirmar que el LLM respondiÃ³ correctamente.

#### ğŸ“‰ **Respuesta irrelevante o de baja calidad**
- **Causa comÃºn:**
  - Datos poco relevantes en Qdrant.
  - Embedding inadecuado para tu dominio.
  - Prompt del LLM mal calibrado.
  - Contexto truncado por `RAG_MAX_CONTEXT_TOKENS`.
- **SoluciÃ³n:**
  - Mejora la calidad de datos en `kelly_soap` y `kelly_indexer`.
  - Prueba otros modelos (`multilingual-e5-base`, `mpnet`, etc.).
  - Ajusta valores `.env`: `RAG_TOP_K`, `RAG_MAX_CONTEXT_TOKENS`.
  - Refina las instrucciones en el prompt del sistema.
ğŸ›Ÿ **Â¿AÃºn con problemas?**
- Ejecuta con `LOG_LEVEL=DEBUG` para mayor detalle.
- Usa Swagger para validar requests.
- Si estÃ¡s usando GPU, prueba forzar `EMBEDDING_DEVICE=cpu` para descartar errores de CUDA.

## ğŸ§‘â€ğŸ’» 13. GuÃ­as para Desarrolladores
Esta secciÃ³n estÃ¡ pensada para quienes contribuirÃ¡n activamente al cÃ³digo de **Kelly API**. AquÃ­ aprenderÃ¡s cÃ³mo preparar tu entorno, cumplir con los estÃ¡ndares de calidad, ejecutar pruebas y participar en el proceso de desarrollo colaborativo.

### ğŸš€ **Primeros Pasos**
Antes de comenzar a programar, asegÃºrate de tener tu entorno listo:
1. **Clona el repositorio:**
   ```bash
   git clone <URL_DEL_REPO>
   cd kelly_api
   ```
2. **Crea y activa tu entorno Conda:**
   ```bash
   conda create -n kelly_api_env python=3.10 -y
   conda activate kelly_api_env
   ```
3. **Instala dependencias del proyecto:**
   ```bash
   pip install -e .[dev,test]
   ```
4. **Configura tu archivo `.env`:**
   - Copia desde `.env.sample`
   - AÃ±ade credenciales de Qdrant, DeepSeek, MongoDB, etc.
### ğŸ“ **EstÃ¡ndares de CÃ³digo y Herramientas de Calidad**
El proyecto utiliza herramientas configuradas desde `pyproject.toml`:
| Herramienta | Uso |
|-------------|-----|
| **Ruff**    | Linter + formateador rÃ¡pido, incluye `isort` |
| **Black**   | Formateador adicional (opcional) |
| **MyPy**    | VerificaciÃ³n estÃ¡tica de tipos |
#### âœ”ï¸ Comandos Ãºtiles:
```bash
# Formatear el cÃ³digo
ruff format app/ tests/ scripts/
# Aplicar fixes y revisar errores de estilo
ruff check app/ tests/ scripts/ --fix
# Chequeo de tipos
mypy app/
```
ğŸ‘‰ Corre estos comandos antes de hacer `commit` o enviar un PR.

### ğŸ” **Proceso de ContribuciÃ³n (Flujo Sugerido)**
1. **ComunicaciÃ³n:** Discute nuevas features o cambios mayores abriendo un **Issue**.
2. **Branching:** Crea una rama a partir de `main`:
   ```bash
   git checkout -b feature/mi-mejora
   ```
3. **Desarrollo:** Implementa tus cambios.
4. **Testing:** Agrega pruebas en `tests/`. Corre:
   ```bash
   pytest --cov=app
   ```
5. **Calidad:** Ejecuta Ruff y MyPy como se mostrÃ³ arriba.
6. **Commit y push:**
   ```bash
   git commit -m "feat: agrega autenticaciÃ³n JWT"
   git push origin feature/mi-mejora
   ```
7. **Pull Request:** Crea un PR desde tu rama hacia `main`. Incluye:
   - DescripciÃ³n de los cambios
   - Captura de errores solucionados (si aplica)
   - Referencia al Issue (si corresponde)
8. **RevisiÃ³n:** Colabora con el equipo para ajustar lo necesario hasta ser aprobado.
9. **Merge:** SerÃ¡ fusionado cuando todo estÃ© validado. âœ…

### ğŸ **Reporte de Errores y Sugerencias**
#### ğŸ“£ Reportar Bugs:
- Abre un **Issue** con:
  - VersiÃ³n de Kelly API
  - Pasos para reproducir
  - Mensaje de error/log completo
  - Tu entorno (SO, Python, etc.)
#### ğŸ’¡ Proponer Mejoras:
- Usa la etiqueta `enhancement` o `feature request`.
- Describe claramente:
  - QuÃ© hace falta
  - Por quÃ© es Ãºtil
  - Ejemplo de uso deseado
